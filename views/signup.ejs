<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Trace Mc</title>
    <link rel="icon" type="image/png" href="media/favicon.png">
    <link rel="stylesheet" href="css/global.css" />
    <link rel="stylesheet" href="css/auth.css" />
  </head>
  <body>
    <%- include('components/navbar', { user: null }) %>
    
    <div class="auth-container">
      <div class="auth-card">
        <div class="auth-header">
          <img src="media/logo_small.png" alt="Trace MC" class="auth-logo">
          <h1 class="auth-title">Join Trace MC</h1>
          <p class="auth-subtitle">Create your account to get started</p>
        </div>
        
        <form class="auth-form" data-error="<%= err %>" action="/signup" method="post" novalidate>
          <div class="form-group">
            <label for="username" class="form-label">Username</label>
            <input
              type="text"
              id="username"
              name="name"
              class="form-input"
              required
              pattern="[a-zA-Z0-9]{3,12}"
              placeholder="Choose a username (3-12 characters)"
            />
          </div>
          
          <div class="form-group">
            <label for="email" class="form-label">Email</label>
            <input
              type="email"
              id="email"
              name="email"
              class="form-input"
              required
              placeholder="Enter your email address"
            />
          </div>
          
          <div class="form-group">
            <label for="password" class="form-label">Password</label>
            <input
              type="password"
              id="password"
              name="password"
              class="form-input"
              required
              pattern="^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[@$!%*?&])[A-Za-z\d@$!%*?&]{8,}$"
              placeholder="Create a strong password"
              oninput="checkPasswordStrength()"
            />
            <div class="password-strength" id="password-strength">
              <div class="strength-bar">
                <div class="strength-fill" id="strength-fill"></div>
              </div>
              <div class="strength-text" id="strength-text">Password strength</div>
            </div>
          </div>
          
          <div class="checkbox-group">
            <input type="checkbox" id="terms" class="checkbox-input" required>
            <label for="terms" class="checkbox-label">
              I agree to the <a href="/terms" target="_blank">Terms of Service</a> and <a href="/privacy" target="_blank">Privacy Policy</a>
            </label>
          </div>
          
          <button type="button" class="btn btn-primary auth-submit" onclick="submit_form()">
            Create Account
          </button>
        </form>
        
        <div class="auth-footer">
          <p>Already have an account? <a href="/login" class="auth-link">Sign in</a></p>
        </div>
      </div>
    </div>
    
    <div class="alert alert-error auth-alert hidden" id="error-alert">
      <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" width="20" height="20">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
      </svg>
      <span id="error_msg">Something went wrong</span>
    </div>
    
    <script>
      const errorMsg = document.getElementById("error_msg");
      const errorAlert = document.getElementById("error-alert");
      
      function close() {
        setTimeout(() => {
          errorAlert.classList.add("hidden");
        }, 3000);
      }
      
      function checkPasswordStrength() {
        const password = document.getElementById("password").value;
        const strengthIndicator = document.getElementById("password-strength");
        const strengthFill = document.getElementById("strength-fill");
        const strengthText = document.getElementById("strength-text");
        
        if (password.length === 0) {
          strengthIndicator.classList.remove("show");
          return;
        }
        
        strengthIndicator.classList.add("show");
        
        let strength = 0;
        let feedback = [];
        
        // Length check
        if (password.length >= 8) strength++;
        else feedback.push("at least 8 characters");
        
        // Lowercase check
        if (/[a-z]/.test(password)) strength++;
        else feedback.push("lowercase letter");
        
        // Uppercase check
        if (/[A-Z]/.test(password)) strength++;
        else feedback.push("uppercase letter");
        
        // Number check
        if (/\d/.test(password)) strength++;
        else feedback.push("number");
        
        // Special character check
        if (/[^A-Za-z0-9]/.test(password)) strength++;
        else feedback.push("special character");
        
        // Update UI
        strengthFill.className = "strength-fill";
        if (strength <= 2) {
          strengthFill.classList.add("weak");
          strengthText.textContent = `Weak - Add: ${feedback.slice(0, 2).join(", ")}`;
        } else if (strength <= 4) {
          strengthFill.classList.add("medium");
          strengthText.textContent = feedback.length > 0 ? `Good - Add: ${feedback.join(", ")}` : "Good password";
        } else {
          strengthFill.classList.add("strong");
          strengthText.textContent = "Strong password";
        }
      }
      
      function submit_form() {
        const username = document.getElementById("username").value;
        const email = document.getElementById("email").value;
        const password = document.getElementById("password").value;
        const terms = document.getElementById("terms").checked;

        if (!username) {
          errorMsg.textContent = "Username is required";
          errorAlert.classList.remove("hidden");
          close();
        } else if (username.length < 3) {
          errorMsg.textContent = "Username must be at least 3 characters";
          errorAlert.classList.remove("hidden");
          close();
        } else if (!/^[a-zA-Z0-9]+$/.test(username)) {
          errorMsg.textContent = "Username can only contain letters and numbers";
          errorAlert.classList.remove("hidden");
          close();
        } else if (!email) {
          errorMsg.textContent = "Email is required";
          errorAlert.classList.remove("hidden");
          close();
        } else if (email.indexOf("@") === -1 || email.indexOf(".") === -1) {
          errorMsg.textContent = "Please enter a valid email address";
          errorAlert.classList.remove("hidden");
          close();
        } else if (!password) {
          errorMsg.textContent = "Password is required";
          errorAlert.classList.remove("hidden");
          close();
        } else if (password.length < 8) {
          errorMsg.textContent = "Password must be at least 8 characters";
          errorAlert.classList.remove("hidden");
          close();
        } else if (
          !/[a-z]/.test(password) ||
          !/[A-Z]/.test(password) ||
          !/[^A-Za-z0-9]/.test(password)
        ) {
          errorMsg.textContent = "Password must contain uppercase, lowercase, and special characters";
          errorAlert.classList.remove("hidden");
          close();
        } else if (!terms) {
          errorMsg.textContent = "Please accept the terms and conditions";
          errorAlert.classList.remove("hidden");
          close();
        } else {
          document.querySelector(".auth-form").submit();
        }
      }
      
      // Page load errors
      window.addEventListener("load", function () {
        const err = document.querySelector(".auth-form").getAttribute("data-error");
        if (err == "error-1") {
          errorMsg.textContent = "Username already exists";
          errorAlert.classList.remove("hidden");
          close();
        } else if (err == "error-2") {
          errorMsg.textContent = "Email already exists";
          errorAlert.classList.remove("hidden");
          close();
        } else if (err == "error-3") {
          errorMsg.textContent = "Something went wrong. Please try again.";
          errorAlert.classList.remove("hidden");
          close();
        }
      });
    </script>
  </body>
</html>
